<!DOCTYPE html>
<html lang="en">
<head>
    <!--[if lt IE 9]>
    <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>gridstack-angular demo</title>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
    <link rel="stylesheet" href="bower_components/gridstack/dist/gridstack.css"/>
    <link rel="stylesheet" href="gridstack-extra.css"/>


    <style type="text/css">
        #belt-grid {
            margin-top: 30px;
            background-image: linear-gradient(to right, grey 1px, transparent 1px),
                linear-gradient(to bottom, grey 1px, transparent 1px);
        }
        .grid-stack-item-content {
            color: #2c3e50;
            text-align: center;
            background: #33c6ff;
        }

        .grid-stack-item-content p {
            font-weight: bold;
            line-height: 1.1em;
            margin: 5px;
        }

        .grid-stack-item-content p.dimensions {
            margin: 15px 0;
        }

    </style>
</head>
<body ng-app="GridStack" ng-controller="DemoCtrl" ng-init="init()">
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-1">
                <p>Scale</p>
                <p>1' x 1.00"</p>
                <hr />
                <button type="button" class="btn btn-primary" ng-click="addWidget(10,10)">Add Cut</button>
                <button type="button" class="btn" ng-click="changeZoom(1)"> Zoom In </button>
                <button type="button" class="btn" ng-click="changeZoom(-1)"> Zoom Out </button>
            </div>
    
            <div class="col-md-11">
                <div id="info-general">
                    <p>SIZE: {{beltLength}}' X {{beltWidth | number : 4}}" ITEM: {{itemID}} BELT LOT: {{lot}} CUST: {{customerName}}</p>
                    <p>REQUIRED: 2 CUTS - 80'6.0000" X 36.0000 ****1 OF 2 ADDED ****</p>
                </div>
                <div id="belt-grid">
                    <div class='ruler-horizontal'></div>
                    <div gridstack class="grid-stack" options="options" on-resize-stop="onResizeStop(event,ui)">
                        <div class='ruler-vertical'></div>
                        <div gridstack-item ng-repeat="w in widgets" ng-switch="w.Status" class="grid-stack-item" id="cut_{{$index}}" data-item-id={{w.Id}} gs-item-x="w.X" gs-item-y="w.Y"
                            gs-item-width="w.Width" gs-item-height="w.Length" gs-item-autopos="w.AutoPos" on-item-added="onItemAdded(item)">
                                <div ng-switch-when="0">
                                    <div class="grid-stack-item-content current" ng-mouseover="showTooltip($event)" ng-mouseout="hideTooltip($event)">
                                        <div class="tooltip">
                                            <p class="dimensions">{{w.Width | number : 4}}" x {{w.Length / 12 | number : 4}}'</p>
                                            <div ng-repeat="info in w.DisplayInfo">
                                                <p>{{info.Label}}: {{info.Value}}</p>
                                            </div>
                                        </div>
                                        <a ng-click="validateCreateOffcut(w)">Config</a>
                                        <p class="dimensions">{{w.Width | number : 4}} x {{w.Length / 12 | number : 4}}</p>
                                        <div ng-repeat="info in w.DisplayInfo">
                                            <p>{{info.Label}}: {{info.Value}}</p>
                                        </div>
                                        <a class="btn btn-primary offcutX" ng-click="offcutX(w)" >offcut x</a>
                                        <a class="btn btn-primary offcutY" ng-click="offcutY(w)" >offcut y</a>
                                        <a class="btn btn-primary" ng-click="removeWidget(w)" >remove</a>
                                    </div>
                                </div>
                                <div ng-switch-when="1">
                                    <div class="grid-stack-item-content cut" ng-mouseover="showTooltip($event)" ng-mouseout="hideTooltip($event)">
                                        <div class="tooltip">
                                            <p class="dimensions">{{w.Width | number : 4}}" x {{w.Length / 12 | number : 4}}'</p>
                                            <div ng-repeat="info in w.DisplayInfo">
                                                <p>{{info.Label}}: {{info.Value}}</p>
                                            </div>
                                        </div>
                                        <a ng-click="validateCreateOffcut(w)">Config</a>
                                        <p class="dimensions">{{w.Width | number : 4}} x {{w.Length / 12 | number : 4}}</p>
                                        <div ng-repeat="info in w.DisplayInfo">
                                            <p>{{info.Label}}: {{info.Value}}</p>
                                        </div>
                                        <a class="btn btn-primary offcutX" ng-click="offcutX(w)" >offcut x</a>
                                        <a class="btn btn-primary offcutY" ng-click="offcutY(w)" >offcut y</a>
                                        <a class="btn btn-primary" ng-click="removeWidget(w)" >remove</a>
                                    </div>
                                </div>
                                <div ng-switch-when="2">
                                    <div class="grid-stack-item-content not-cut" ng-mouseover="showTooltip($event)" ng-mouseout="hideTooltip($event)">
                                        <a ng-click="validateCreateOffcut(w)">Config</a>
                                        <p class="dimensions">{{w.Width | number : 4}} x {{w.Length / 12 | number : 4}}</p>
                                        <div ng-repeat="info in w.DisplayInfo">
                                            <p>{{info.Label}}: {{info.Value}}</p>
                                        </div>
                                        <a class="btn btn-primary offcutX" ng-click="offcutX(w)" >offcut x</a>
                                        <a class="btn btn-primary offcutY" ng-click="offcutY(w)" >offcut y</a>
                                        <a class="btn btn-primary" ng-click="removeWidget(w)" >remove</a>
                                    </div>
                                </div>
                                <div ng-switch-when="3">
                                    <div class="grid-stack-item-content another-lot" ng-mouseover="showTooltip($event)" ng-mouseout="hideTooltip($event)">
                                        <div class="tooltip">
                                            <p class="dimensions">{{w.Width | number : 4}}" x {{w.Length / 12 | number : 4}}'</p>
                                            <div ng-repeat="info in w.DisplayInfo">
                                                <p>{{info.Label}}: {{info.Value}}</p>
                                            </div>
                                        </div>
                                        <a ng-click="validateCreateOffcut(w)">Config</a>
                                        <p class="dimensions">{{w.Width | number : 4}} x {{w.Length / 12 | number : 4}}</p>
                                        <div ng-repeat="info in w.DisplayInfo">
                                            <p>{{info.Label}}: {{info.Value}}</p>
                                        </div>
                                        <a class="btn btn-primary offcutX" ng-click="offcutX(w)" >offcut x</a>
                                        <a class="btn btn-primary offcutY" ng-click="offcutY(w)" >offcut y</a>
                                        <a class="btn btn-primary" ng-click="removeWidget(w)" >remove</a>
                                    </div>
                                </div>
                                <div ng-switch-when="4">
                                    <div class="grid-stack-item-content deleted" ng-mouseover="showTooltip($event)" ng-mouseout="hideTooltip($event)">
                                        <a ng-click="validateCreateOffcut(w)">Config</a>
                                        <p class="dimensions">{{w.Width | number : 4}} x {{w.Length / 12 | number : 4}}</p>
                                        <div ng-repeat="info in w.DisplayInfo">
                                            <p>{{info.Label}}: {{info.Value}}</p>
                                        </div>
                                        <a class="btn btn-primary offcutX" ng-click="offcutX(w)" >offcut x</a>
                                        <a class="btn btn-primary offcutY" ng-click="offcutY(w)" >offcut y</a>
                                        <a class="btn btn-primary" ng-click="removeWidget(w)" >remove</a>
                                    </div>
                                </div>
                                <div ng-switch-when="5">
                                    <div class="grid-stack-item-content offcut" ng-mouseover="showTooltip($event)" ng-mouseout="hideTooltip($event)">
                                        <div class="tooltip">
                                            <p class="dimensions">{{w.Width | number : 4}}" x {{w.Length / 12 | number : 4}}'</p>
                                            <div ng-repeat="info in w.DisplayInfo">
                                                <p>{{info.Label}}: {{info.Value}}</p>
                                            </div>
                                        </div>
                                        <a ng-click="validateCreateOffcut(w)">Config</a>
                                        <p class="dimensions">{{w.Width | number : 4}} x {{w.Length / 12 | number : 4}}</p>
                                        <div ng-repeat="info in w.DisplayInfo">
                                            <p>{{info.Label}}: {{info.Value}}</p>
                                        </div>
                                        <a class="btn btn-primary offcutX" ng-click="offcutX(w)" >offcut x</a>
                                        <a class="btn btn-primary offcutY" ng-click="offcutY(w)" >offcut y</a>
                                        <a class="btn btn-primary" ng-click="removeWidget(w)" >remove</a>
                                    </div>
                                </div>
                                <div ng-switch-default>
                                    <div class="grid-stack-item-content other" ng-mouseover="showTooltip($event)" ng-mouseout="hideTooltip($event)">
                                        <a ng-click="offcutX(w)">Config</a>
                                        <p class="dimensions">{{w.Width | number : 4}} x {{w.Length / 12 | number : 4}}</p>
                                        <div ng-repeat="info in w.DisplayInfo">
                                            <p>{{info.Label}}: {{info.Value}}</p>
                                        </div>
                                        <a class="btn btn-primary offcutX" ng-click="offcutX(w)" >offcut x</a>
                                        <a class="btn btn-primary offcutY" ng-click="offcutY(w)" >offcut y</a>
                                        <a class="btn btn-primary" ng-click="removeWidget(w)" >remove</a>
                                    </div>
                                </div>
                        </div>
                    </div>
                </div>
                <div>
                    <button class="btn-save" ng-click="buttonSaveData()">Save</button>
                </div>
            </div>
        </div>
    </div>

    <script src="bower_components/jquery/dist/jquery.min.js"></script>
    <script src="bower_components/jquery-ui/jquery-ui.js"></script>
    <script src="bower_components/lodash/dist/lodash.min.js"></script>
    <script src="bower_components/angular/angular.min.js"></script>
    <script src="bower_components/gridstack/dist/gridstack.js"></script>
    <script src="../src/gridstack.controller.js"></script>
    <script src="../src/gridstack.directive.js"></script>
    <script src="../src/gridstackitem.directive.js"></script>

    <script type="text/javascript">
        var app = angular.module('GridStack', ['gridstack-angular']).
          controller('DemoCtrl', function($scope, $log) {

            var jsonData = {
                "ItemID": "TVVBELT",
                "ItemDesc": "TVV Belt Item",
                "Lot": "TVVLOT3-4-5",
                "BeltLength": "240.0000",
                "BeltWidth": "84.0000",
                "LotCost": "0.455789358",
                "RemnantLength": "5.000000000",
                "RemnantWidth": "5.000000000",
                "CustomerID": "0",
                "CustomerName": "",
                "CurrentTransType": "4",
                "CutLength": "0",
                "CutWidth": "0",
                "ExistingCuts": [
                    {
                        "Id": "178",
                        "X": "0",
                        "Y": "10",
                        "Length": "100",
                        "Width": "10",
                        "Offcut": "",
                        "ParentId": "",
                        "Status": "0",
                        "RowStatus": "0",
                        "DisplayInfo": [
                            {
                                "Label": "Type",
                                "Value": "Inv Adjust"
                            },
                            {
                                "Label": "Adj #",
                                "Value": "104207"
                            },
                            {
                                "Label": "Adj Date",
                                "Value": "8/28/2017"
                            },
                            {
                                "Label": "Reason",
                                "Value": "NEW"
                            },
                            {
                                "Label": "Desc/New Lot",
                                "Value": "TVVLOT3-4-5"
                            }
                        ]
                    },
                    {
                        "Id": "180",
                        "X": "10",
                        "Y": "10",
                        "Length": "100",
                        "Width": "10",
                        "Offcut": "",
                        "ParentId": "",
                        "Status": "0",
                        "RowStatus": "0",
                        "DisplayInfo": [
                            {
                                "Label": "Type",
                                "Value": "Inv Adjust"
                            },
                            {
                                "Label": "Adj #",
                                "Value": "104209"
                            },
                            {
                                "Label": "Adj Date",
                                "Value": "8/28/2017"
                            },
                            {
                                "Label": "Reason",
                                "Value": "NEW"
                            },
                            {
                                "Label": "Desc/New Lot",
                                "Value": "TVVLOT3-4-5"
                            }
                        ]
                    },
                    {
                        "Id": "177",
                        "X": "0",
                        "Y": "0",
                        "Length": "10",
                        "Width": "10",
                        "Offcut": "",
                        "ParentId": "",
                        "Status": "1",
                        "RowStatus": "0",
                        "DisplayInfo": [
                            {
                                "Label": "Type",
                                "Value": "Prod Order"
                            },
                            {
                                "Label": "Prod Ord #",
                                "Value": "10001390"
                            },
                            {
                                "Label": "Order #",
                                "Value": "1927822"
                            },
                            {
                                "Label": "Order Date",
                                "Value": "8/28/2017"
                            },
                            {
                                "Label": "Cust ID",
                                "Value": "1006739"
                            },
                            {
                                "Label": "Cust",
                                "Value": "TVV Customer"
                            }
                        ]
                    },
                    {
                        "Id": "179",
                        "X": "10",
                        "Y": "0",
                        "Length": "10",
                        "Width": "10",
                        "Offcut": "",
                        "ParentId": "",
                        "Status": "1",
                        "RowStatus": "0",
                        "DisplayInfo": [
                            {
                                "Label": "Type",
                                "Value": "Prod Order"
                            },
                            {
                                "Label": "Prod Ord #",
                                "Value": "10001391"
                            },
                            {
                                "Label": "Order #",
                                "Value": "1927823"
                            },
                            {
                                "Label": "Order Date",
                                "Value": "8/28/2017"
                            },
                            {
                                "Label": "Cust ID",
                                "Value": "1006739"
                            },
                            {
                                "Label": "Cust",
                                "Value": "TVV Customer"
                            }
                        ]
                    },
                    {
                        "Id": "186",
                        "X": "20",
                        "Y": "20",
                        "Length": "15",
                        "Width": "20",
                        "Offcut": "",
                        "ParentId": "",
                        "Status": "2",
                        "RowStatus": "0",
                        "DisplayInfo": [
                            {
                                "Label": "Type",
                                "Value": "Prod Order"
                            },
                            {
                                "Label": "Prod Ord #",
                                "Value": "10001397"
                            },
                            {
                                "Label": "Order #",
                                "Value": "1928979"
                            },
                            {
                                "Label": "Order Date",
                                "Value": "6/29/2018"
                            },
                            {
                                "Label": "Cust ID",
                                "Value": "1006739"
                            },
                            {
                                "Label": "Cust",
                                "Value": "TVV Customer"
                            }
                        ]
                    },
                    {
                        "Id": "187",
                        "X": "20",
                        "Y": "35",
                        "Length": "75",
                        "Width": "20",
                        "Offcut": "Y",
                        "ParentId": "186",
                        "Status": "6",
                        "RowStatus": "0",
                        "DisplayInfo": [
                            {
                                "Label": "Type",
                                "Value": "Prod Order"
                            },
                            {
                                "Label": "Prod Ord #",
                                "Value": "10001397"
                            },
                            {
                                "Label": "Order #",
                                "Value": "1928979"
                            },
                            {
                                "Label": "Order Date",
                                "Value": "6/29/2018"
                            },
                            {
                                "Label": "Cust ID",
                                "Value": "1006739"
                            },
                            {
                                "Label": "Cust",
                                "Value": "TVV Customer"
                            }
                        ]
                    },
                    {
                        "Id": "185",
                        "X": "20",
                        "Y": "0",
                        "Length": "20",
                        "Width": "10",
                        "Offcut": "",
                        "ParentId": "",
                        "Status": "2",
                        "RowStatus": "0",
                        "DisplayInfo": [
                            {
                                "Label": "Type",
                                "Value": "Prod Order"
                            },
                            {
                                "Label": "Prod Ord #",
                                "Value": "10001396"
                            },
                            {
                                "Label": "Order #",
                                "Value": "1928931"
                            },
                            {
                                "Label": "Order Date",
                                "Value": "6/12/2018"
                            },
                            {
                                "Label": "Cust ID",
                                "Value": "1006739"
                            },
                            {
                                "Label": "Cust",
                                "Value": "TVV Customer"
                            }
                        ]
                    }
                ],
                "CurrentCuts": []
            };

            // var jsonData = {"ItemID":"BELT TEST","ItemDesc":"60in Belting Material Test","Lot":"12345","BeltLength":"12000.0000","BeltWidth":"60.0000","LotCost":"0","RemnantLength":"0","RemnantWidth":"0","CustomerID":"0","CustomerName":"","CurrentTransType":"0","CutLength":"0","CutWidth":"0","ExistingCuts":[{"Id":"2","X":"0","Y":"0","Length":"2400","Width":"30","Offcut":"","ParentId":"","Status":"1","RowStatus":"0","DisplayInfo":[{"Label":"Type","Value":"Order"},{"Label":"Order #","Value":"1000020"},{"Label":"Order Date","Value":"2019-02-04"},{"Label":"Cust ID","Value":"10014"},{"Label":"Cust","Value":"Cameron"}]},{"Id":"3","X":"30","Y":"0","Length":"2400","Width":"30","Offcut":"","ParentId":"","Status":"6","RowStatus":"0","DisplayInfo":[{"Label":"Type","Value":"Order"},{"Label":"Order #","Value":"1000020"},{"Label":"Order Date","Value":"2019-02-04"},{"Label":"Cust ID","Value":"10014"},{"Label":"Cust","Value":"Cameron"}]},{"Id":"4","X":"0","Y":"2400","Length":"1200","Width":"30","Offcut":"","ParentId":"","Status":"1","RowStatus":"0","DisplayInfo":[{"Label":"Type","Value":"Order"},{"Label":"Order #","Value":"1000020"},{"Label":"Order Date","Value":"2019-02-04"},{"Label":"Cust ID","Value":"10014"},{"Label":"Cust","Value":"Cameron"}]},{"Id":"5","X":"30","Y":"2400","Length":"600","Width":"30","Offcut":"","ParentId":"","Status":"1","RowStatus":"0","DisplayInfo":[{"Label":"Type","Value":"Order"},{"Label":"Order #","Value":"1000020"},{"Label":"Order Date","Value":"2019-02-04"},{"Label":"Cust ID","Value":"10014"},{"Label":"Cust","Value":"Cameron"}]}],"CurrentCuts":[]}

            $scope.beltLength = jsonData.BeltLength / 12;
            $scope.beltWidth = jsonData.BeltWidth;
            $scope.widgets = [];
            $scope.zoom = 10;
            $scope.gridCutId = 0; // Current session ids for cuts
            $scope.cutBeingMadeWidth = 0;
            $scope.cutBeingMadeLengthFt = 0;
            $scope.cutBeingMadeLengthIn = 0;
            $scope.lastCutAddedId = 0;
            $scope.numberCutsAdded = 0;
            var currentTransType;
            var cutsIdToAdd = [];
            var cutsToUpdate = [];

            $scope.options = {
                width: $scope.beltWidth,
                height: jsonData.BeltLength,
                cellHeight: 1.66666667, // 20px / 12 (IN to FT)
                verticalMargin: 0
            };

            $scope.viewMode = function() {
                if (currentTransType == '0') {
                    return true;
                }
                return false;
            };

            $scope.addMoreCuts = function() {
                if (currentTransType == '0') {
                    return false;
                }

                if (currentTransType == '4' && $scope.numberCutsAdded >= 1) {
                    return false;
                }

                return true;
            };

            function deserializeData() {
                // Belting grid data
                $scope.itemID = jsonData.ItemID;
                $scope.itemDesc = jsonData.ItemDesc;
                $scope.lot = jsonData.Lot;
                $scope.lotCost = jsonData.LotCost;
                $scope.customerName = jsonData.CustomerName;
                $scope.cutLength = jsonData.CutLength;
                $scope.cutWidth = jsonData.CutWidth;
                $scope.requiredCuts = jsonData.CutQty;
                $scope.remnantLength = jsonData.RemnantLength;
                $scope.remnantWidth = jsonData.RemnantWidth;
                $scope.maxAvailLength = jsonData.MaxAvailLength;
                $scope.maxAvailWidth = jsonData.MaxAvailWidth;
                currentTransType = jsonData.CurrentTransType;
            }

            function sortByKey(array, key) {
                array.sort(function(a, b) {
                    var x = parseInt(a[key]); var y = parseInt(b[key]);
                    return ((x < y) ? -1 : ((x > y) ? 1 : 0));
                });
            }

            function addGridIdToExistingCuts() {
                for (var i = 0; i < jsonData.ExistingCuts.length; i++) {
                    $scope.widgets.push(JSON.parse(JSON.stringify(jsonData.ExistingCuts[i])));
                    $scope.widgets[i].GridCutID = i;
                }
            }

            function addWidget (width, length) {
                // AutoPositioning value must be declared because loaded values don't need autopositioning,
                // but that variable needs to be erased before calling changeData. Only gridstack needs it
                var newWidget = { Id: 0, GridCutID: $scope.gridCutId, Width: width, Length: length, Offcut: 'N', ParentId: '', Status: 0,
                    RowStatus: 0, DisplayInfo: '', AutoPos: 1, LengthFt: Math.floor(length / 12), LengthIn: (length % 12), LotCost: $scope.lotCost,
                    remnantLength: $scope.remnantLength, remnantWidth: $scope.remnantWidth};
                $scope.widgets.push(newWidget);

                $scope.cutBeingMadeWidth = width;
                $scope.cutBeingMadeLengthFt = Math.floor(length / 12);
                $scope.cutBeingMadeLengthIn = length % 12;

                $scope.lastCutAddedId = $scope.gridCutId;
                $scope.numberCutsAdded++;
            }

            function removeWidget (gridCutId) {
                // Get widget index
                var index = $scope.widgets.findIndex(
                    function(data) {
                        return data.GridCutID == gridCutId;
                    }
                );

                var widget = JSON.parse(JSON.stringify($scope.widgets[index]));
                // Erase from widgets
                $scope.widgets.splice(index, 1);

                // Erase from cuts to add or send to currentCuts to erase it if it does not exist in the current session
                if (cutsIdToAdd.includes(gridCutId)) {
                    var indexCut = cutsIdToAdd.indexOf(gridCutId);
                    cutsIdToAdd.splice(indexCut, 1);
                }
                else {
                    var removedCut = { GridCutID: widget.GridCutID, Id: widget.Id, X: widget.X, Y: widget.Y, Width: widget.Width,
                        Length: widget.Length, Offcut: widget.Offcut, ParentId: widget.ParentId, Status: widget.Status, RowStatus: '2',
                        DisplayInfo: widget.DisplayInfo };

                    // Save as a removed cut
                    jsonData.CurrentCuts.push(removedCut);
                }

                // Remove the cut from cutsToUpdate if it exists
                var indexCutsToUpdate = cutsToUpdate.findIndex(
                    function(data) {
                        return data.GridCutID == gridCutId;
                    }
                );

                if (indexCutsToUpdate != -1) {
                    // Remove from cuts that need to be updated
                    cutsToUpdate.splice(indexCutsToUpdate, 1);
                }

                // Decrease number of cuts added
                $scope.numberCutsAdded--;
            }

            function getItemById (id) {
                return jsonData.ExistingCuts.filter(
                    function(data) {
                        return data.Id == id;
                    }
                );
            }

            function changeLengthById(gridCutId, length) {
                // Get widget index
                var index = $scope.widgets.findIndex(
                    function(data) {
                        return data.GridCutID == gridCutId;
                    }
                );

                if (length) {
                    $scope.widgets[index].LengthFt = Math.floor(length / 12);
                    $scope.widgets[index].LengthIn = length % 12;
                }
                else {
                    $scope.widgets[index].LengthFt = Math.floor($scope.widgets[index].Length / 12);
                    $scope.widgets[index].LengthIn = $scope.widgets[index].Length % 12;
                }

                if (gridCutId == $scope.lastCutAddedId && length) {
                    $scope.cutBeingMadeLengthFt = Math.floor(length / 12);
                    $scope.cutBeingMadeLengthIn = length % 12;
                    $scope.cutBeingMadeWidth = $scope.widgets[index].Width;
                }
                else if (gridCutId == $scope.lastCutAddedId) {
                    $scope.cutBeingMadeLengthFt = Math.floor($scope.widgets[index].Length / 12);
                    $scope.cutBeingMadeLengthIn = $scope.widgets[index].Length % 12;
                    $scope.cutBeingMadeWidth = $scope.widgets[index].Width;
                }
            }

            $scope.onResizeStop = function(event) {
                var element = event.target;
                var id = angular.element(element).attr('id').slice(4);

                changeLengthById(id);
            };

            $scope.onItemAdded = function(item, currentCut) {
                var grid = angular.element('.grid-stack').data('gridstack');

                // Add UI id and lengthFt/In  to the cuts coming from the backend
                if (currentCut.Id) {
                    currentCut.LengthFt = Math.floor(currentCut.Length / 12);
                    currentCut.LengthIn = currentCut.Length % 12;
                }
                // Add cuts created in this specific session
                else {
                    cutsIdToAdd.push($scope.gridCutId);
                }

                // Add offcut id to offcuts created in other sessions
                if (currentCut.Id && currentCut.ParentId) {
                    var originalCut = document.querySelector('[data-item-id="' + currentCut.ParentId + '"]');
                    originalCut.setAttribute('data-offcut-id', $scope.gridCutId);
                    grid.movable(originalCut, false);
                    grid.resizable(originalCut, false);
                }

                // Only current cuts are able to move in the grid
                if (currentCut.Status == '0' && currentTransType != '0') {
                    grid.movable(item.el, true);
                    grid.resizable(item.el, true);
                }

                var element = document.getElementById('cut_' + $scope.gridCutId);
                var id = $(element).attr('data-item-id');
                var existingCut = getItemById(id);

                grid.locked(item.el, true);

                // Update Y position for cuts coming from previous sessions
                if (existingCut[0] != undefined && existingCut[0].Y !== $(element).attr('data-gs-y')) {
                    grid.move(item.el, null, parseInt(existingCut[0].Y));
                }

                // Update Y for horizontal offcuts with the Y position of its parent
                if (currentCut.UpdateY) {
                    var originalCut = document.getElementById('cut_' + currentCut.ParentId).dataset;
                    grid.move(item.el, null, parseInt(originalCut.gsY));
                }

                $scope.gridCutId++;
            };

            function createOffcutX (currentCut, parentId) {
                var offcutWidth = 0;
                var newOffcut = {};
                var grid = angular.element('.grid-stack').data('gridstack');

                if (currentCut.X == 0) {
                    var closestCutX = $scope.beltWidth;
                    angular.element('.grid-stack-item').each(function (idx, gsEl) {
                        var elementData = gsEl.dataset;
                        if (currentCut.GridCutId != elementData.gridId) {
                            // Get which cuts are on the same Y range and get the closest
                            if (currentCut.Y + currentCut.Length > parseInt(elementData.gsY) &&
                                    currentCut.Y < parseInt(elementData.gsY) + parseInt(elementData.gsHeight) &&
                                    parseInt(elementData.gsX) > currentCut.X) {
                                if (closestCutX > parseInt(elementData.gsX)) {
                                    closestCutX = parseInt(elementData.gsX);
                                }
                            }
                        }
                    });

                    offcutWidth = closestCutX - currentCut.Width;
                    newOffcut = { Id: 0, GridCutID: $scope.gridCutId, X: currentCut.X + currentCut.Width, Y: currentCut.Y, Width: offcutWidth,
                        Length: currentCut.Length, Offcut: 'Y', ParentId: parentId, Status: 5, RowStatus: 3, DisplayInfo: currentCut.DisplayInfo,
                        UpdateY: true};
                }
                else {
                    var closestCutX = 0;
                    angular.element('.grid-stack-item').each(function (idx, gsEl) {
                        var elementData = gsEl.dataset;
                        if (currentCut.GridCutId != elementData.gridId) {
                            // Get which cuts are on the same Y range and get the closest
                            if (currentCut.Y + currentCut.Length > parseInt(elementData.gsY) &&
                                    currentCut.Y < parseInt(elementData.gsY) + parseInt(elementData.gsHeight) &&
                                    parseInt(elementData.gsX) < currentCut.X) {
                                if (parseInt(elementData.gsX) + parseInt(elementData.gsWidth) > closestCutX) {
                                    closestCutX = parseInt(elementData.gsX) + parseInt(elementData.gsWidth);
                                }
                            }
                        }
                    });

                    offcutWidth = $scope.beltWidth - closestCutX - currentCut.Width;
                    newOffcut = { Id: 0, GridCutID: $scope.gridCutId, X: closestCutX, Y: currentCut.Y, Width: offcutWidth, Length: currentCut.Length,
                        Offcut: 'Y', ParentId: parentId, Status: 5, RowStatus: 3, DisplayInfo: currentCut.DisplayInfo, UpdateY: true};
                }

                // Double check if offcut calculations are valid
                if (grid.willItFit(newOffcut.X, newOffcut.Y, newOffcut.Width, newOffcut.Length, false)) {
                    $scope.widgets.push(newOffcut);
                }
                else {
                    // Return empty object if its not valid
                    newOffcut = {};
                }

                return newOffcut;
            }

            function createOffcutY (currentCut, parentId) {
                var closestCutY = ($scope.beltLength * 12);
                var grid = angular.element('.grid-stack').data('gridstack');
                var newOffcut = {};

                angular.element('.grid-stack-item').each(function (idx, gsEl) {
                    var elementData = gsEl.dataset;
                    if (currentCut.GridCutId != elementData.gridId) {
                        // Get which cuts are on the same X range and get the closest
                        if (currentCut.X + currentCut.Width > parseInt(elementData.gsX) &&
                                currentCut.X < parseInt(elementData.gsX) + parseInt(elementData.gsWidth) &&
                                parseInt(elementData.gsY) > currentCut.Y) {
                            if (closestCutY > parseInt(elementData.gsY)) {
                                closestCutY = parseInt(elementData.gsY);
                            }
                        }
                    }
                });

                var offcutLength = closestCutY - currentCut.Length - currentCut.Y;

                if (grid.willItFit(currentCut.X, currentCut.Y + currentCut.Length, currentCut.Width, offcutLength, false)) {
                    newOffcut = { Id: 0, GridCutID: $scope.gridCutId, X: currentCut.X, Y: currentCut.Y + currentCut.Length, Width: currentCut.Width,
                        Length: offcutLength, Offcut: 'Y', ParentId: parentId, Status: 5, RowStatus: 3, DisplayInfo: currentCut.DisplayInfo};

                    $scope.widgets.push(newOffcut);
                }

                return newOffcut;
            }

            function validateCreateOffcut (currentCut) {
                var canCreateOffcutX = false;
                var canCreateOffcutY = false;

                var grid = angular.element('.grid-stack').data('gridstack');

                // Check there are no adjacent cuts for X
                if ((currentCut.X == 0 && grid.isAreaEmpty(currentCut.X + currentCut.Width, currentCut.Y, 1, currentCut.Length)) ||
                    (currentCut.X + currentCut.Width == $scope.beltWidth) && grid.isAreaEmpty(currentCut.X - 1, currentCut.Y, 1, currentCut.Length)) {
                    canCreateOffcutX = true;
                }

                // Check there are no adjacent cuts for Y and it's not on beltLength limit
                if (grid.isAreaEmpty(currentCut.X, currentCut.Y + currentCut.Length, currentCut.Width, 1) &&
                    grid.willItFit(currentCut.X, currentCut.Y + currentCut.Length, currentCut.Width, 1, false)) {
                    canCreateOffcutY = true;
                }

                return [canCreateOffcutX, canCreateOffcutY];
            }

            function willResizeFit (currentCut, newWidth, newLength) {
                var grid = angular.element('.grid-stack').data('gridstack');
                var xPos = parseInt(currentCut.X);
                var yPos = parseInt(currentCut.Y);
                var width = parseInt(currentCut.Width);
                var length = parseInt(currentCut.Length);

                // check if new width is valid
                if (newWidth > width) {
                    if (!grid.isAreaEmpty(xPos + width, yPos, newWidth - width, length) ||
                        (newWidth + xPos) > parseInt($scope.beltWidth)) {
                        return false;
                    }
                }

                // check if new length is valid
                if (newLength > length) {
                    if (!grid.willItFit(xPos, yPos + length, width, newLength - length, false) ||
                        !grid.isAreaEmpty(xPos, yPos + length, width, newLength - length)) {
                        return false;
                    }
                }

                if (newWidth > width && newLength > length) {
                    if (!grid.isAreaEmpty(xPos + width, yPos + length, newWidth - width, newLength - length)) {
                        return false;
                    }
                }
                return true;
            }

            function createRulerDimensions() {
                var numItemsHorizontal = $scope.beltWidth / 12;
                var numItemsVertical = $scope.beltLength / 5;
                var rulerHorizontal = document.querySelector('.ruler-horizontal');
                var rulerVertical = document.querySelector('.ruler-vertical');

                rulerVertical.style.height = (($scope.beltLength + 1) * 20) + 'px';

                for (var i = 0; i <= numItemsHorizontal; i++) {
                    var element = document.createElement('div');
                    element.className = 'in';
                    element.dataset.text = (i * 12) + '.0"';
                    rulerHorizontal.appendChild(element);
                }

                for (var i = 0; i <= numItemsVertical; i++) {
                    var element = document.createElement('div');
                    element.className = 'in';
                    element.dataset.text = (i * 5) + '.0\'';
                    rulerVertical.appendChild(element);
                }
            }

            function createRulerDimensionsDesc() {
                var numItemsHorizontal = $scope.beltWidth / 12;
                var numItemsVertical = $scope.beltLength / 5;
                var rulerHorizontal = document.querySelector('.ruler-horizontal');
                var rulerVertical = document.querySelector('.ruler-vertical');

                rulerVertical.style.height = (($scope.beltLength + 1) * 20) + 'px';

                for (var i = 0; i <= numItemsHorizontal; i++) {
                    var element = document.createElement('div');
                    element.className = 'in';
                    element.dataset.text = (i * 12) + '.0"';
                    rulerHorizontal.appendChild(element);
                }

                for (var i = numItemsVertical; i >= 0; i--) {
                    var element = document.createElement('div');
                    element.className = 'in';
                    element.dataset.text = (i * 5) + '.0\'';
                    rulerVertical.appendChild(element);
                }
            }

            function createGridStyles() {
                var grid = document.querySelector('#belt-grid');
                grid.style.height = (($scope.beltLength) * 20 + 1) + 'px';
                grid.style.width = ($scope.beltWidth * 20) + 'px';
                grid.style.backgroundSize = (100 / ($scope.beltWidth + 1)) + '% ' + '20px';
            }

            function setZoom(zoom, el) {
                var transformOrigin = [0, 0];
                //el = el || instance.getContainer();
                var p = ['webkit', 'moz', 'ms', 'o'];
                var s = 'scale(' + zoom + ')';
                var oString = (transformOrigin[0] * 100) + '% ' + (transformOrigin[1] * 100) + '%';

                for (var i = 0; i < p.length; i++) {
                    el.style[p[i] + 'Transform'] = s;
                    el.style[p[i] + 'TransformOrigin'] = oString;
                }

                el.style['transform'] = s;
                el.style['transformOrigin'] = oString;
            }

            $scope.changeZoom = function(a) {
                var tooltips = document.querySelectorAll('.tooltiptext');
                var fontSize = 4.5;
                var width = 200;
                var height = 140;

                if (($scope.zoom != 7 && a != 1) || ($scope.zoom != 14 && a != -1)) {
                    $scope.zoom += a;
                    var zoomScale = Number($scope.zoom) / 10;
                    setZoom(zoomScale, document.getElementById('belt-grid'));

                    // TODO: Update rulers length instead of zooming everything ( text gets too small)
                    // rulerHorizontal.style.width = `${widthHorizontalRuler * zoomScale}px`;
                    // rulerVertical.style.height = `${widthVerticalRuler * zoomScale}px`;

                    // TODO: Add tooltips functions when cuts get too small
                    // if (zoom < 10) {
                    //     tooltips.forEach(tooltip => {
                    //         tooltip.style.fontSize = `${fontSize / zoomScale}em`;
                    //         tooltip.style.width = `${width / zoomScale}px`;
                    //         tooltip.style.height = `${height / zoomScale}px`;
                    //     });
                    // }
                }
                //gridData['DemoGrid'].hideInfoCutIfOverflow();
            };

            $scope.addNewCut = function () {
                var newScope = $rootScope.$new(true);
                newScope.cutLength = $scope.cutLength;
                newScope.cutWidth = $scope.cutWidth;

                epModalDialogService.showCustomDialog({
                    templateOptions: {
                        templateUrl: 'app/directives/belt-grid/addCut.html',
                        templateScope: newScope
                    },
                    title: 'Enter Cut Size',
                    status: 'information',
                    backdrop: true,
                    buttons: [{
                        text: 'Save',
                        type: 'primary',
                        action:function(){
                            var width = parseInt(document.querySelector('.width').value);
                            var lengthFT = parseInt(document.querySelector('.lenFT').value) || 0;
                            var lengthIN = parseInt(document.querySelector('.lenIN').value) || 0;
                            var totalLength = (lengthFT * 12) + lengthIN;

                            var grid = angular.element('.grid-stack').data('gridstack');
                            if (grid.willItFit(0, 0, width, totalLength, true) && width <= $scope.beltWidth) {
                                addWidget(width, totalLength);
                            }
                            else {
                                // eslint-disable-next-line no-alert
                                alert('Not enough free space to place cut');
                            }
                        }
                    }, {
                        text: 'Cancel',
                        isCancel: true
                    }],
                    closeButton: true
                });
            };

            $scope.editCut = function (currentCut, event) {
                currentCut.X = parseInt(currentCut.X);
                currentCut.Y = parseInt(currentCut.Y);
                currentCut.Width = parseInt(currentCut.Width);
                currentCut.Length = parseInt(currentCut.Length);

                var currentCutGridId = angular.element(event.target).parents('.grid-stack-item')[0].id.replace('cut_', '');
                var currentCutElement = document.getElementById('cut_' + currentCutGridId);
                var currentCutId = currentCutElement.getAttribute('data-item-id');
                var offcutId = currentCutElement.getAttribute('data-offcut-id');
                var values = validateCreateOffcut(currentCut);
                var canCreateOffcutX = values[0];
                var canCreateOffcutY = values[1];
                var grid = angular.element('.grid-stack').data('gridstack');
                var element = event.target;
                var el = angular.element(element).parents('.grid-stack-item');

                var template = '<div id="belt-cut-edit" title="Cut Settings">';

                if (offcutId) {
                    template += '<button class="btn" ng-click="removeOffcut()"> Remove Offcut</button></div>';
                }
                else {
                    template +=
                    '<div class="info">' +
                            '<div>' +
                                'Length:' +
                                '<input type="text" class="lenFT" value="' + Math.floor(currentCut.Length / 12) + '"> FT ' +
                                '<input type="text" class="lenIN" value="' + currentCut.Length % 12 + '"> IN ' +
                            '</div>' +
                            '<div>' +
                                'Width: <input type="text" class="width" value="' + currentCut.Width + '"> IN ' +
                            '</div>' +
                    '</div>';
                    if (canCreateOffcutX && currentTransType == '3' && !offcutId) {
                        template += '<button class="btn" ng-click="offcutX()"> Horizontal Offcut</button>';
                    }

                    if (canCreateOffcutY && currentTransType == '3' && !offcutId) {
                        template += '<button class="btn" ng-click="offcutY()"> Vertical Offcut</button>';
                    }

                    template += '<button class="btn" ng-click="remove()"> Remove</button></div>';
                }

                epModalDialogService.showCustomDialog({
                    templateOptions: {
                        template: template
                    },
                    title: 'Edit Cut Size',
                    status: 'information',
                    backdrop: true,
                    buttons: [{
                        text: 'OK',
                        type: 'primary',
                        action:function(){
                            /* Edit cut info */
                            var width = parseInt(document.querySelector('.width').value);
                            var lengthFT = parseInt(document.querySelector('.lenFT').value) || 0;
                            var lengthIN = parseInt(document.querySelector('.lenIN').value) || 0;
                            var totalLength = (lengthFT * 12) + lengthIN;

                            if (willResizeFit(currentCut, width, totalLength)) {
                                grid.resize(el, width, totalLength);
                                changeLengthById(currentCutGridId, totalLength);
                            }
                            else {
                                // eslint-disable-next-line no-alert
                                alert('Not a valid size');
                            }
                        }
                    }, {
                        text: 'Cancel',
                        isCancel: true
                    }],
                    controller: /*@ngInject*/ function ($scope) {
                        $scope.offcutX = function () {
                            var createdOffcut = createOffcutX(currentCut, currentCutGridId);
                            epModalDialogService.hide('current');
                            // Validate createdOffcut is not empty
                            if (JSON.stringify(createdOffcut) != JSON.stringify({})) {
                                currentCutElement.setAttribute('data-offcut-id', createdOffcut.GridCutID);
                                editOffcutCost(currentCut, createdOffcut);
                                grid.resizable(el, false);
                                grid.movable(el, false);
                            }
                            else {
                                // eslint-disable-next-line no-alert
                                alert('Error creating offcut');
                            }
                        };

                        $scope.offcutY = function () {
                            var createdOffcut = createOffcutY(currentCut, currentCutGridId);
                            epModalDialogService.hide('current');
                            // Validate createdOffcut is not empty
                            if (JSON.stringify(createdOffcut) != JSON.stringify({})) {
                                currentCutElement.setAttribute('data-offcut-id', createdOffcut.GridCutID);
                                editOffcutCost(currentCut, createdOffcut);
                                grid.resizable(el, false);
                                grid.movable(el, false);
                            }
                            else {
                                // eslint-disable-next-line no-alert
                                alert('Error creating offcut');
                            }
                        };

                        $scope.remove = function() {
                            removeWidget(parseInt(currentCutGridId));
                            epModalDialogService.hide('current');
                        };

                        $scope.removeOffcut = function() {
                            removeWidget(parseInt(offcutId));
                            currentCutElement.setAttribute('data-offcut-id', '');
                            epModalDialogService.hide('current');
                            grid.resizable(el, true);
                            grid.movable(el, true);
                        };
                    },
                    closeButton: true
                });
            };

            function editOffcutCost(currentCut, offcut) {
                var newScope = $rootScope.$new(true);
                newScope.currentCut = currentCut;
                newScope.offcut = offcut;
                newScope.itemID = $scope.itemID;
                newScope.itemDesc = $scope.itemDesc;
                newScope.cutLength = $scope.cutLength;
                newScope.cutWidth = $scope.cutWidth;
                newScope.remnantLength = currentCut.remnantLength;
                newScope.remnantWidth = currentCut.remnantWidth;

                newScope.totalQty = (currentCut.Width * currentCut.Length) + (offcut.Width * offcut.Length);
                newScope.offcutCostPercentage = (offcut.Width * offcut.Length) / newScope.totalQty * 100;
                newScope.offcutCost = (offcut.Width * offcut.Length * currentCut.LotCost);
                newScope.maxOffcutPercentage = (offcut.Width * offcut.Length) / newScope.totalQty * 100; //It is used to hold the original amount to be used in validations)
                newScope.maxOffcutCost = (offcut.Width * offcut.Length * currentCut.LotCost); //It is used to hold the original amount to be used in validations
                newScope.totalCost = currentCut.LotCost * newScope.totalQty;

                newScope.cutPercentage = 100 - newScope.offcutCostPercentage;
                newScope.cutCost = ((newScope.totalQty * newScope.cutPercentage) / 100) * currentCut.LotCost;

                epModalDialogService.showCustomDialog({
                    templateOptions: {
                        templateUrl: 'app/directives/belt-grid/editoffcutcost.html',
                        templateScope: newScope
                    },
                    title: 'Calculate Cost',
                    status: 'information',
                    backdrop: true,
                    buttons: [{
                        text: 'Save',
                        type: 'primary',
                        action:function(){
                            /* Edit cut info */
                        }
                    }],
                    controller: /*@ngInject*/ function () {
                        //$scope.currentCut = w;
                    },
                    closeButton: true
                });
            }

            function createCSSFile() {
                var style = document.createElement('style');
                var columns = $scope.beltWidth;

                for (var i = 1; i <= columns; i++) {
                    var widthClass = '#belt-grid .grid-stack > .grid-stack-item[data-gs-width="' + i + '"] { ' +
                            'width: ' + (100 / columns) * i + '%; ' +
                        '}';
                    var xPositionClass = '#belt-grid .grid-stack > .grid-stack-item[data-gs-x="' + i + '"] {' +
                            'left: ' + (100 / columns) * i + '%; ' +
                        '}';
                    var minWidthClass = '#belt-grid .grid-stack > .grid-stack-item[data-gs-min-width="' + i + '"] {' +
                            'min-width: ' + (100 / columns) * i + '%; ' +
                        '}';
                    var maxWidthClass = '#belt-grid .grid-stack > .grid-stack-item[data-gs-max-width="' + i + '"] {' +
                            'max-width: ' + (100 / columns) * i + '%; ' +
                        '}';

                    style.innerHTML += widthClass;
                    style.innerHTML += xPositionClass;
                    style.innerHTML += minWidthClass;
                    style.innerHTML += maxWidthClass;
                }
                document.head.appendChild(style);
            }

            function getItemsToUpdate() {
                return $scope.widgets.filter(
                    function(data) {
                        return data.Status == '0';
                    }
                );
            }

            $scope.buttonSaveData = function() {
                for (var i = 0; i < cutsIdToAdd.length; i++) {
                    // get element
                    var element = document.getElementById('cut_' + cutsIdToAdd[i]).dataset;
                    // pass data to array
                    var addedCut = { Id: 0, GridCutID: cutsIdToAdd[i], X: element.gsX, Y: element.gsY, Width: element.gsWidth, Length: element.gsHeight,
                        Offcut: element.isOffcut, ParentId: element.parentId, Status: parseInt(element.status),
                        RowStatus: parseInt(element.rowStatus), DisplayInfo: '' };
                    // push to current cuts
                    jsonData.CurrentCuts.push(addedCut);
                }

                for (var i = 0; i < cutsToUpdate.length; i++) {
                    // get element
                    var element = document.querySelector('[data-item-id=\'' + cutsToUpdate[i].Id + '\']').dataset;
                    // pass data to array
                    var editedCut = {GridCutID: cutsToUpdate[i].GridCutID, Id: cutsToUpdate[i].Id, X: element.gsX, Y: element.gsY, Width: element.gsWidth, Length: element.gsHeight,
                        Offcut: cutsToUpdate[i].Offcut, ParentId: cutsToUpdate[i].ParentId, Status: parseInt(cutsToUpdate[i].Status),
                        RowStatus: 1, DisplayInfo: cutsToUpdate[i].DisplayInfo };
                    // push to current cuts
                    jsonData.CurrentCuts.push(editedCut);
                }

                windowService.changeData($scope, '_dw_belt_info_json.belt_info_json', JSON.stringify(jsonData)).then(
                    function() {
                        windowService.runWindowTool($scope, 'cb_ok');
                    }
                );
            };

            $scope.buttonCancel = function() {
                windowService.runWindowTool($scope, 'cb_cancel');
            };

            var init = function () {
                deserializeData();
                // Sort Y positions to avoid position errors and cuts out of place
                sortByKey(jsonData.ExistingCuts, 'Y');
                addGridIdToExistingCuts();
                createCSSFile();
                createGridStyles();
                cutsToUpdate = getItemsToUpdate();
                $scope.numberCutsAdded = cutsToUpdate.length;
                createRulerDimensions();
            };

            init();
        }
        });
    </script>

</body>
</html>